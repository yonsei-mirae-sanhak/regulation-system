<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê·œì • ìƒì„¸ â€” ê·œì •ê´€ë¦¬ì‹œìŠ¤í…œ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="css/common.css">
</head>
<body>

<header id="header"></header>

<div id="layout">
  <nav id="sidebar"></nav>
  <div id="main">
    <div id="content">
      <div class="loading-wrap"><div class="spinner"></div><span>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span></div>
    </div>
  </div>
</div>

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal-backdrop" id="deleteModal">
  <div class="modal sm">
    <div class="modal-hd">
      <div class="modal-ttl">ê·œì • ì‚­ì œ</div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="warn-box">âš ï¸ ì‚­ì œí•˜ë©´ ëª¨ë“  ê°œì • ì´ë ¥ì´ í•¨ê»˜ ì‚­ì œë˜ë©°, ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
      <p style="font-size:14px;color:var(--text-2)"><strong id="deleteTargetName"></strong> ê·œì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    </div>
    <div class="modal-ft">
      <button class="btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn-danger" onclick="confirmDelete()">ì‚­ì œ</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script src="js/config.js"></script>
<script src="js/sample-data.js"></script>
<script src="js/db.js"></script>
<script src="js/auth.js"></script>
<script src="js/ui.js"></script>
<script>
let currentReg = null;

(async () => {
  const id = getParam('id');
  if (!id) { location.href = 'index.html'; return; }

  await commonInit(null, null, null);

  // DBì—ì„œ ë‹¨ê±´ ì¡°íšŒ
  currentReg = await DB.fetchOne(id);
  if (!currentReg) {
    document.getElementById('content').innerHTML = '<div class="empty-tbl">ê·œì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  renderDetail(currentReg);
})();

function renderDetail(reg) {
  const canDiff = reg.history.length >= 2;

  document.getElementById('content').innerHTML = `
    <div class="breadcrumb">
      <a class="bc-link" href="index.html">í™ˆ</a> â€º
      <a class="bc-link" href="list.html?group=${encodeURIComponent(reg.group)}">${reg.group}</a>
      ${reg.category ? `â€º <a class="bc-link" href="list.html?group=${encodeURIComponent(reg.group)}&cat=${encodeURIComponent(reg.category)}">${reg.category}</a>` : ''}
      â€º ${reg.title}
    </div>
    <div class="detail-card">
      <div class="print-header">
        <h1>${reg.title}</h1>
        <p>${reg.group}${reg.category ? ' â€º ' + reg.category : ''} | ì‹œí–‰ì¼: ${reg.date || 'ë¯¸ì •'} | ${reg.dept || ''}</p>
      </div>
      <div class="detail-card-hd">
        <div class="detail-cat">${reg.group}${reg.category ? ' â€º ' + reg.category : ''}</div>
        <div class="detail-ttl">${reg.title}</div>
      </div>
      <div class="meta-strip">
        <div class="meta-cell"><div class="meta-k">ìƒíƒœ</div><div class="meta-v">${sBadge(reg.status)}</div></div>
        <div class="meta-cell"><div class="meta-k">ì‹œí–‰ì¼</div><div class="meta-v">${reg.date || 'ë¯¸ì •'}</div></div>
        <div class="meta-cell"><div class="meta-k">ë‹´ë‹¹ë¶€ì„œ</div><div class="meta-v">${reg.dept || 'â€”'}</div></div>
        <div class="meta-cell"><div class="meta-k">ê°œì • íšŸìˆ˜</div><div class="meta-v">${reg.history.length}íšŒ</div></div>
      </div>
      <div class="detail-body-sec">
        <div class="sec-ttl">ê·œì • ë‚´ìš©</div>
        <div class="detail-body-txt">${escHtml(reg.body)}</div>
      </div>
      <div class="detail-body-sec" style="padding-top:0">
        <div class="sec-ttl">ê°œì • ì´ë ¥</div>
        <table class="history-tbl">
          <thead><tr><th>ê°œì •ì¼</th><th>ì‹œí–‰ì¼</th><th>ê°œì • ë‚´ìš©</th></tr></thead>
          <tbody>
            ${[...reg.history].reverse().map((h, i) => `
              <tr ${i === 0 ? 'class="cur-row"' : ''}>
                <td style="font-family:'DM Mono',monospace;font-size:12px;white-space:nowrap">
                  ${h.revDate || h.date || 'â€”'}
                  ${i === 0 ? '<span style="font-family:Pretendard;font-size:10px;background:var(--accent);color:#fff;padding:1px 6px;border-radius:3px;font-weight:600;margin-left:6px">í˜„í–‰</span>' : ''}
                </td>
                <td style="font-family:'DM Mono',monospace;font-size:12px;white-space:nowrap;color:var(--text-3)">${h.date || 'â€”'}</td>
                <td>${h.note}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
      <div class="detail-actions">
        ${Auth.isAdmin ? `<a class="btn-edit" href="edit.html?id=${reg.id}">âœï¸ ìˆ˜ì •</a>` : ''}
        ${canDiff ? `<a class="btn-diff" href="diff.html?id=${reg.id}">ğŸ“„ ì‹ êµ¬ëŒ€ì¡°í‘œ</a>` : ''}
        ${canDiff ? `<a class="btn-diff" href="timeline.html?id=${reg.id}">ğŸ• ì¡°í•­ì—°í˜</a>` : ''}
        <button class="btn-pdf" onclick="printPDF()">ğŸ–¨ï¸ PDF ì¶œë ¥</button>
        ${Auth.isAdmin ? `<button class="btn-del" onclick="openDeleteModal()">ğŸ—‘ï¸ ì‚­ì œ</button>` : ''}
      </div>
    </div>`;
}

function openDeleteModal() {
  document.getElementById('deleteTargetName').textContent = currentReg.title;
  document.getElementById('deleteModal').classList.add('open');
}
function closeModal() {
  document.getElementById('deleteModal').classList.remove('open');
}
async function confirmDelete() {
  const ok = await DB.remove(currentReg.id);
  if (ok) {
    showToast('ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    setTimeout(() => location.href = 'list.html', 800);
  } else {
    showToast('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
  }
  closeModal();
}

function printPDF() {
  window.print();
}

document.querySelector('.modal-backdrop').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeModal();
});
</script>
</body>
</html>
