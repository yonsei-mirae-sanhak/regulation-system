<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê·œì •ì •ë³´ â€” ê·œì •ê´€ë¦¬ì‹œìŠ¤í…œ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="css/common.css">
</head>
<body>

<header id="header"></header>

<div id="layout">
  <nav id="sidebar"></nav>
  <div id="main">
    <div id="content">
      <div class="loading-wrap"><div class="spinner"></div><span>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span></div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script src="js/config.js"></script>
<script src="js/sample-data.js"></script>
<script src="js/db.js"></script>
<script src="js/auth.js"></script>
<script src="js/ui.js"></script>
<script>
(async () => {
  const group   = getParam('group');
  const cat     = getParam('cat');
  const q       = getParam('q');
  const type    = getParam('type') || 'title';
  const recent  = getParam('recent');

  const nav = recent ? 'recent' : 'list';
  await commonInit(nav, group, cat);

  const regs = _allRegs;
  let filtered = regs;
  let label = 'ì „ì²´ ê·œì •';

  if (recent) {
    filtered = [...regs].sort((a, b) =>
      (b.history.at(-1)?.date || '').localeCompare(a.history.at(-1)?.date || ''));
    label = 'ìµœì‹  ì œÂ·ê°œì • ê·œì •';
  } else if (q) {
    filtered = regs.filter(r => type === 'title' ? r.title.includes(q) : (r.body || '').includes(q));
    label = `ê²€ìƒ‰: "${escHtml(q)}"`;
  } else {
    if (group) filtered = filtered.filter(r => r.group === group);
    if (cat)   filtered = filtered.filter(r => r.category === cat);
    label = group ? (cat ? `${escHtml(group)} â€º ${escHtml(cat)}` : escHtml(group)) : 'ì „ì²´ ê·œì •';
  }

  const isRecent = !!recent;

  document.getElementById('content').innerHTML = `
    <div class="view-hd">
      <div class="view-ttl">
        ${isRecent ? 'ğŸ†•' : 'ğŸ“‚'} ${label}
        <span class="cat-badge">${filtered.length}ê±´</span>
      </div>
      ${Auth.isAdmin ? `<a class="btn-new-reg" href="edit.html">ï¼‹ ê·œì • ë“±ë¡</a>` : ''}
    </div>
    ${filtered.length === 0
      ? '<div class="reg-table"><div class="empty-tbl">ë“±ë¡ëœ ê·œì •ì´ ì—†ìŠµë‹ˆë‹¤</div></div>'
      : `<div class="reg-table">
          <table>
            <thead>
              <tr>
                ${isRecent ? '<th style="width:6%">êµ¬ë¶„</th>' : ''}
                <th style="width:${isRecent?'32':'38'}%">ê·œì •ëª…</th>
                <th>ë¶„ë¥˜</th>
                <th style="width:10%">ìƒíƒœ</th>
                <th>ì‹œí–‰ì¼</th>
                <th>ê´€ë¦¬ë¶€ì„œ</th>
              </tr>
            </thead>
            <tbody>
              ${filtered.map(r => {
                const last = r.history.at(-1);
                return `<tr onclick="location.href='detail.html?id=${encodeURIComponent(r.id)}'" style="cursor:pointer">
                  ${isRecent ? `<td>${rtypeBadge(r)}</td>` : ''}
                  <td class="td-ttl">${escHtml(r.title)}</td>
                  <td style="font-size:12px;color:var(--text-3)">${escHtml(r.group)}${r.category?' â€º '+escHtml(r.category):''}</td>
                  <td>${sBadge(r.status)}</td>
                  <td style="font-size:12px;color:var(--text-3);font-family:'DM Mono',monospace">${escHtml(r.date || 'â€”')}</td>
                  <td style="font-size:12px;color:var(--text-3)">${escHtml(r.dept || 'â€”')}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>`}`;
})();
</script>
</body>
</html>
