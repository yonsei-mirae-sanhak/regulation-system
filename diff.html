<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‹ êµ¬ëŒ€ì¡°í‘œ â€” ê·œì •ê´€ë¦¬ì‹œìŠ¤í…œ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="css/common.css">
</head>
<body>

<header id="header"></header>

<div id="layout">
  <nav id="sidebar"></nav>
  <div id="main">
    <div id="content">
      <div class="loading-wrap"><div class="spinner"></div><span>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span></div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script src="js/config.js"></script>
<script src="js/sample-data.js"></script>
<script src="js/db.js"></script>
<script src="js/auth.js"></script>
<script src="js/ui.js"></script>
<script src="js/diff-engine.js"></script>
<script>
let reg = null;

(async () => {
  const id = getParam('id');
  if (!id) { location.href = 'index.html'; return; }

  await commonInit(null, null, null);
  reg = await DB.fetchOne(id);
  if (!reg || reg.history.length < 2) {
    document.getElementById('content').innerHTML = '<div class="empty-tbl">ë¹„êµí•  ê°œì • ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  const oi = parseInt(getParam('old') ?? reg.history.length - 2);
  const ni = parseInt(getParam('new') ?? reg.history.length - 1);
  renderDiffPage(oi, ni);
})();

function renderDiffPage(oi, ni) {
  const h = reg.history;
  const oldH = h[oi], newH = h[ni];
  const diffRows = computeDiff(oldH.body || '', newH.body || '');

  const verOpts = (sel) => h.map((v, i) =>
    `<option value="${i}" ${i===sel?'selected':''}>${v.date||'ë‚ ì§œì—†ìŒ'} (${i===0?'ì œì •':'ê°œì •'})</option>`
  ).join('');

  document.getElementById('content').innerHTML = `
    <div class="breadcrumb">
      <a class="bc-link" href="index.html">í™ˆ</a> â€º
      <a class="bc-link" href="list.html?group=${encodeURIComponent(reg.group)}">${reg.group}</a> â€º
      <a class="bc-link" href="detail.html?id=${reg.id}">${reg.title}</a> â€º ì‹ êµ¬ëŒ€ì¡°í‘œ
    </div>
    <div class="diff-page">
      <div class="diff-header">
        <div class="diff-title">ğŸ“„ ì‹ êµ¬ì¡°ë¬¸ ëŒ€ì¡°í‘œ</div>
        <div class="diff-subtitle">${reg.title}</div>
      </div>
      <div class="diff-ver-selector">
        <label>í˜„í–‰(êµ¬)</label>
        <select class="diff-ver-select" id="diffOld">${verOpts(oi)}</select>
        <span class="diff-arrow">â†’</span>
        <label>ê°œì •(ì‹ )</label>
        <select class="diff-ver-select" id="diffNew">${verOpts(ni)}</select>
        <button class="btn-diff-apply" onclick="applyDiff()">ëŒ€ì¡° ë³´ê¸°</button>
      </div>
      <div class="diff-legend">
        <span style="font-size:12px;font-weight:600;color:var(--text-2);margin-right:8px">ë²”ë¡€</span>
        <div class="legend-item"><div class="legend-box legend-del"></div><span>ì‚­ì œÂ·ë³€ê²½(êµ¬)</span></div>
        <div class="legend-item"><div class="legend-box legend-add"></div><span>ì¶”ê°€Â·ë³€ê²½(ì‹ )</span></div>
        <div class="legend-item"><div class="legend-box legend-same"></div><span>ë™ì¼</span></div>
      </div>
      <div class="diff-col-header">
        <div class="diff-col-hd old">í˜„ í–‰ (${oldH.date || 'â€”'})</div>
        <div class="diff-col-hd new">ê°œ ì • (${newH.date || 'â€”'})</div>
      </div>
      <div class="diff-body">${renderDiffRows(diffRows)}</div>
    </div>`;
}

function applyDiff() {
  const oi = parseInt(document.getElementById('diffOld').value);
  const ni = parseInt(document.getElementById('diffNew').value);
  if (oi === ni) { showToast('âš ï¸ ì„œë¡œ ë‹¤ë¥¸ ë²„ì „ì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
  renderDiffPage(oi, ni);
}
</script>
</body>
</html>
