<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê·œì •ê´€ë¦¬ì‹œìŠ¤í…œ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600;700&family=DM+Mono:wght@400;500&family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --navy:#1b2a4a; --accent:#1a56a0; --accent-h:#154080; --accent-light:#e8f0fa;
  --gold:#c4860a; --gold-light:#fdf4e3;
  --paper:#f5f6f8; --paper-2:#eceef2; --white:#fff; --border:#d8dce6;
  --text:#1e2535; --text-2:#4a5272; --text-3:#8a90a8;
  --red:#c0392b; --green:#1a7a50; --green-light:#e6f5ee;
  --add-bg:#e8f8ee; --add-border:#5cb87a; --add-text:#145a2a;
  --del-bg:#fdecea; --del-border:#e07070; --del-text:#8b1a1a;
  --sidebar-w:260px; --header-h:56px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Pretendard',sans-serif;background:var(--paper);color:var(--text);min-height:100vh;}

/* HEADER */
#header{position:fixed;top:0;left:0;right:0;height:var(--header-h);background:var(--navy);display:flex;align-items:center;padding:0 20px;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,.25);}
.header-logo{display:flex;align-items:center;gap:12px;cursor:pointer;}
.logo-icon{width:32px;height:32px;background:var(--accent);border-radius:7px;display:grid;place-items:center;font-size:16px;}
.logo-text{font-family:'Noto Serif KR',serif;font-size:16px;font-weight:700;color:#fff;letter-spacing:-.3px;}
.logo-sub{font-size:11px;color:rgba(255,255,255,.4);margin-top:1px;}
.header-nav{display:flex;margin-left:40px;height:100%;}
.header-nav a{display:flex;align-items:center;padding:0 18px;font-size:13px;font-weight:500;color:rgba(255,255,255,.6);text-decoration:none;border-bottom:2px solid transparent;transition:all .15s;cursor:pointer;height:100%;}
.header-nav a:hover{color:#fff;background:rgba(255,255,255,.05);}
.header-nav a.active{color:#fff;border-bottom-color:#6aabff;}
.header-right{margin-left:auto;}
.btn-admin{padding:6px 14px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.8);font-size:12px;font-family:'Pretendard',sans-serif;cursor:pointer;transition:all .15s;}
.btn-admin:hover{background:rgba(255,255,255,.2);color:#fff;}

/* LAYOUT */
#layout{display:flex;margin-top:var(--header-h);min-height:calc(100vh - var(--header-h));}

/* SIDEBAR */
#sidebar{width:var(--sidebar-w);background:var(--white);border-right:1px solid var(--border);position:fixed;top:var(--header-h);bottom:0;left:0;overflow-y:auto;z-index:100;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
#sidebar::-webkit-scrollbar{width:4px;}
#sidebar::-webkit-scrollbar-thumb{background:var(--border);}
.sb-search-box{padding:14px 14px 10px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--white);z-index:10;}
.sb-search-wrap{position:relative;}
.sb-search-wrap input{width:100%;padding:8px 12px 8px 32px;border:1.5px solid var(--border);border-radius:6px;font-size:12px;font-family:'Pretendard',sans-serif;outline:none;transition:border .2s;background:var(--paper);color:var(--text);}
.sb-search-wrap input:focus{border-color:var(--accent);background:#fff;}
.sb-search-icon{position:absolute;left:9px;top:50%;transform:translateY(-50%);font-size:12px;pointer-events:none;}
.tree-section{padding:8px 0;}
.tree-group-hd{display:flex;align-items:center;gap:6px;padding:8px 14px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--text-3);cursor:pointer;user-select:none;transition:background .1s;}
.tree-group-hd:hover{background:var(--paper);}
.tree-arrow{font-size:9px;transition:transform .2s;display:inline-block;}
.tree-group-hd.open .tree-arrow{transform:rotate(90deg);}
.tree-children{display:none;}
.tree-children.open{display:block;}
.tree-item{display:flex;align-items:center;padding:7px 14px 7px 26px;font-size:13px;color:var(--text-2);cursor:pointer;border-left:3px solid transparent;transition:all .12s;line-height:1.4;}
.tree-item:hover{background:var(--accent-light);color:var(--accent);}
.tree-item.active{background:var(--accent-light);color:var(--accent);border-left-color:var(--accent);font-weight:600;}
.tree-icon{margin-right:7px;font-size:12px;opacity:.6;}
.tree-cnt{margin-left:auto;background:var(--paper-2);color:var(--text-3);font-size:10px;padding:1px 6px;border-radius:10px;font-family:'DM Mono',monospace;}
.tree-item.active .tree-cnt{background:rgba(26,86,160,.15);color:var(--accent);}

/* MAIN */
#main{margin-left:var(--sidebar-w);flex:1;}
#content{padding:28px 36px;}

/* HOME */
.home-search-bar{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:20px 24px;margin-bottom:24px;box-shadow:0 1px 4px rgba(0,0,0,.05);}
.home-search-bar h2{font-size:14px;font-weight:600;color:var(--text-2);margin-bottom:12px;}
.search-row{display:flex;gap:8px;}
.search-type{padding:9px 12px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;font-family:'Pretendard',sans-serif;color:var(--text);outline:none;background:var(--paper);}
.search-inp{flex:1;padding:9px 14px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;font-family:'Pretendard',sans-serif;color:var(--text);outline:none;transition:border .2s;}
.search-inp:focus{border-color:var(--accent);}
.btn-srch{padding:9px 20px;background:var(--accent);color:#fff;border:none;border-radius:7px;font-size:13px;font-weight:600;font-family:'Pretendard',sans-serif;cursor:pointer;transition:background .15s;}
.btn-srch:hover{background:var(--accent-h);}

/* LIST */
.view-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
.view-ttl{font-family:'Noto Serif KR',serif;font-size:20px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:10px;}
.cat-badge{font-size:12px;font-weight:600;padding:3px 10px;background:var(--accent-light);color:var(--accent);border-radius:5px;font-family:'Pretendard',sans-serif;}
.btn-new-reg{padding:8px 18px;background:var(--accent);color:#fff;border:none;border-radius:7px;font-size:13px;font-weight:600;font-family:'Pretendard',sans-serif;cursor:pointer;transition:background .15s;}
.btn-new-reg:hover{background:var(--accent-h);}
.reg-table{width:100%;background:var(--white);border:1px solid var(--border);border-radius:10px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.04);}
.reg-table table{width:100%;border-collapse:collapse;}
.reg-table th{background:var(--paper);padding:11px 16px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text-3);text-align:left;border-bottom:1px solid var(--border);}
.reg-table td{padding:12px 16px;font-size:13px;border-bottom:1px solid var(--paper);vertical-align:middle;}
.reg-table tr:last-child td{border-bottom:none;}
.reg-table tr:hover td{background:var(--accent-light);cursor:pointer;}
.td-ttl{font-weight:500;color:var(--text);}
.td-ver{font-family:'DM Mono',monospace;font-size:12px;color:var(--text-2);}
.empty-tbl{text-align:center;padding:48px;color:var(--text-3);font-size:14px;}
.rtype{flex-shrink:0;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:700;}
.rtype-new{background:var(--green-light);color:var(--green);}
.rtype-rev{background:var(--gold-light);color:var(--gold);}
.rtype-obs{background:var(--paper-2);color:var(--text-3);}
.sbadge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;}
.sbadge-active{background:var(--green-light);color:var(--green);}
.sbadge-draft{background:var(--gold-light);color:var(--gold);}
.sbadge-obsolete{background:var(--paper-2);color:var(--text-3);}

/* DETAIL */
.breadcrumb{font-size:12px;color:var(--text-3);margin-bottom:16px;display:flex;align-items:center;gap:6px;}
.bc-link{cursor:pointer;color:var(--accent);}
.bc-link:hover{text-decoration:underline;}
.detail-card{background:var(--white);border:1px solid var(--border);border-radius:10px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.04);margin-bottom:20px;}
.detail-card-hd{background:var(--navy);padding:20px 28px;}
.detail-cat{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:#6aabff;margin-bottom:6px;}
.detail-ttl{font-family:'Noto Serif KR',serif;font-size:22px;font-weight:700;color:#fff;line-height:1.4;}
.meta-strip{display:flex;flex-wrap:wrap;border-bottom:1px solid var(--border);}
.meta-cell{padding:14px 20px;border-right:1px solid var(--border);min-width:120px;}
.meta-cell:last-child{border-right:none;}
.meta-k{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text-3);margin-bottom:4px;}
.meta-v{font-size:13px;font-weight:500;color:var(--text);}
.detail-body-sec{padding:24px 28px;}
.sec-ttl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-3);margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.detail-body-txt{font-size:14px;line-height:2;color:var(--text-2);white-space:pre-wrap;}
.history-tbl{width:100%;border-collapse:collapse;}
.history-tbl th{background:var(--paper);padding:9px 16px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-3);text-align:left;border-bottom:1px solid var(--border);}
.history-tbl td{padding:11px 16px;font-size:13px;border-bottom:1px solid var(--paper);color:var(--text-2);}
.history-tbl tr:last-child td{border-bottom:none;}
.history-tbl tr.cur-row td{background:var(--accent-light);}
.h-ver{font-family:'DM Mono',monospace;color:var(--accent);font-size:12px;font-weight:500;}
.detail-actions{display:flex;gap:10px;padding:16px 28px;border-top:1px solid var(--border);background:var(--paper);}
.btn-edit{padding:8px 18px;background:var(--accent);color:#fff;border:none;border-radius:7px;font-size:13px;font-weight:600;font-family:'Pretendard',sans-serif;cursor:pointer;transition:background .15s;}
.btn-edit:hover{background:var(--accent-h);}
.btn-del{padding:8px 18px;background:#fff;color:var(--red);border:1.5px solid #f0c0bb;border-radius:7px;font-size:13px;font-weight:600;font-family:'Pretendard',sans-serif;cursor:pointer;transition:all .15s;}
.btn-del:hover{background:#fdf0ef;border-color:var(--red);}
.btn-diff{padding:8px 18px;background:#fff;color:var(--navy);border:1.5px solid var(--border);border-radius:7px;font-size:13px;font-weight:600;font-family:'Pretendard',sans-serif;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:6px;}
.btn-diff:hover{background:var(--accent-light);border-color:var(--accent);color:var(--accent);}

/* â”€â”€ ì‹ êµ¬ëŒ€ì¡°í‘œ â”€â”€ */
.diff-page{background:var(--white);border:1px solid var(--border);border-radius:10px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.04);margin-bottom:20px;}
.diff-header{background:var(--navy);padding:18px 28px;display:flex;align-items:center;justify-content:space-between;}
.diff-title{font-family:'Noto Serif KR',serif;font-size:18px;font-weight:700;color:#fff;}
.diff-subtitle{font-size:12px;color:rgba(255,255,255,.5);margin-top:4px;}
.diff-ver-selector{display:flex;align-items:center;gap:10px;padding:14px 20px;border-bottom:1px solid var(--border);background:var(--paper-2);}
.diff-ver-selector label{font-size:12px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px;}
.diff-ver-select{padding:7px 12px;border:1.5px solid var(--border);border-radius:6px;font-size:13px;font-family:'Pretendard',sans-serif;color:var(--text);background:var(--white);outline:none;transition:border .2s;}
.diff-ver-select:focus{border-color:var(--accent);}
.diff-arrow{font-size:16px;color:var(--text-3);}
.btn-diff-apply{padding:7px 16px;background:var(--accent);color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:600;font-family:'Pretendard',sans-serif;cursor:pointer;}
.btn-diff-apply:hover{background:var(--accent-h);}

.diff-legend{display:flex;gap:20px;padding:12px 20px;border-bottom:1px solid var(--border);font-size:12px;align-items:center;}
.legend-item{display:flex;align-items:center;gap:6px;}
.legend-box{width:14px;height:14px;border-radius:3px;border-width:1px;border-style:solid;}
.legend-add{background:var(--add-bg);border-color:var(--add-border);}
.legend-del{background:var(--del-bg);border-color:var(--del-border);}
.legend-same{background:var(--white);border-color:var(--border);}

.diff-col-header{display:grid;grid-template-columns:1fr 1fr;border-bottom:2px solid var(--border);}
.diff-col-hd{padding:12px 20px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;text-align:center;}
.diff-col-hd.old{background:#fff5f5;color:var(--red);border-right:1px solid var(--border);}
.diff-col-hd.new{background:#f0fff4;color:var(--green);}

.diff-body{padding:0;}
.diff-row{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border);}
.diff-row:last-child{border-bottom:none;}
.diff-cell{padding:16px 20px;font-size:13.5px;line-height:1.9;white-space:pre-wrap;font-family:'Noto Serif KR',serif;vertical-align:top;min-height:40px;}
.diff-cell.old-side{border-right:1px solid var(--border);}
.diff-cell.row-add{background:var(--add-bg);}
.diff-cell.row-del{background:var(--del-bg);}
.diff-cell.row-same{background:var(--white);}
.diff-cell.row-empty{background:var(--paper);color:var(--text-3);font-style:italic;font-size:12px;display:flex;align-items:center;}

/* inline diff highlight */
.ins{background:#b7f5c8;border-radius:2px;padding:1px 2px;color:var(--add-text);}
.del{background:#fdc5c5;border-radius:2px;padding:1px 2px;color:var(--del-text);text-decoration:line-through;}

/* â”€â”€ ì¡°í•­ì—°í˜ â”€â”€ */
.timeline-page{background:var(--white);border:1px solid var(--border);border-radius:10px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.04);margin-bottom:20px;}
.timeline-top{background:var(--navy);padding:18px 28px;}
.timeline-top-title{font-family:'Noto Serif KR',serif;font-size:18px;font-weight:700;color:#fff;}
.timeline-top-sub{font-size:12px;color:rgba(255,255,255,.5);margin-top:4px;}
.timeline-controls{display:flex;align-items:center;gap:12px;padding:12px 20px;border-bottom:1px solid var(--border);background:var(--paper-2);flex-wrap:wrap;}
.timeline-controls label{font-size:12px;font-weight:600;color:var(--text-3);}
.tl-date-select{padding:6px 10px;border:1.5px solid var(--border);border-radius:6px;font-size:12px;font-family:'Pretendard',sans-serif;color:var(--text);background:var(--white);outline:none;}
.tl-date-select:focus{border-color:var(--accent);}
.btn-tl-apply{padding:6px 14px;background:var(--accent);color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:600;font-family:'Pretendard',sans-serif;cursor:pointer;}
.btn-tl-apply:hover{background:var(--accent-h);}
.timeline-scroll-wrap{overflow-x:auto;}
.timeline-table{border-collapse:collapse;table-layout:fixed;}
.timeline-table th{position:sticky;top:0;z-index:10;min-width:280px;max-width:320px;padding:11px 16px;background:#eef2f8;border:1px solid var(--border);font-size:13px;font-weight:700;color:var(--navy);text-align:center;}
.th-ver{font-family:'DM Mono',monospace;font-size:11px;font-weight:500;color:var(--accent);margin-top:3px;}
.th-tag{display:inline-block;padding:1px 7px;border-radius:3px;font-size:10px;font-weight:700;margin-left:6px;vertical-align:middle;}
.th-tag-new{background:var(--green-light);color:var(--green);}
.th-tag-rev{background:var(--gold-light);color:var(--gold);}
.timeline-table td{min-width:280px;max-width:320px;padding:14px 16px;border:1px solid var(--border);font-family:'Noto Serif KR',serif;font-size:13px;line-height:1.85;vertical-align:top;white-space:pre-wrap;}
.tl-art-title{font-weight:700;color:var(--accent);display:block;margin-bottom:3px;}
.td-changed{background:#fffde7;}
.td-added{background:var(--add-bg);}
.td-deleted{background:var(--del-bg);opacity:.6;}
.td-empty{background:var(--paper);color:var(--text-3);font-style:italic;font-size:12px;font-family:'Pretendard',sans-serif;text-align:center;padding:20px;}
.row-label{position:sticky;left:0;z-index:5;width:80px;min-width:80px;background:var(--paper);border:1px solid var(--border);padding:14px 8px;font-size:11px;font-weight:700;color:var(--text-3);text-align:center;vertical-align:top;font-family:'Pretendard',sans-serif;}
.btn-timeline{padding:8px 18px;background:#fff;color:var(--navy);border:1.5px solid var(--border);border-radius:7px;font-size:13px;font-weight:600;font-family:'Pretendard',sans-serif;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:6px;}
.btn-timeline:hover{background:var(--accent-light);border-color:var(--accent);color:var(--accent);}

/* MODAL */
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(10,20,40,.5);backdrop-filter:blur(3px);z-index:500;align-items:center;justify-content:center;}
.modal-backdrop.open{display:flex;}
.modal{background:var(--white);border-radius:12px;width:600px;max-width:calc(100vw - 40px);max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:slideUp .2s ease;}
.modal.sm{width:420px;}
@keyframes slideUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-hd{padding:22px 24px 0;display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.modal-ttl{font-family:'Noto Serif KR',serif;font-size:17px;font-weight:700;}
.modal-close{width:30px;height:30px;border:none;background:none;border-radius:6px;cursor:pointer;color:var(--text-3);font-size:16px;display:grid;place-items:center;transition:background .15s;}
.modal-close:hover{background:var(--paper);}
.modal-body{padding:0 24px 24px;}
.modal-ft{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;}
.form-row{margin-bottom:16px;}
.form-row label{display:block;font-size:11px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;}
.form-row input,.form-row select,.form-row textarea{width:100%;border:1.5px solid var(--border);border-radius:7px;padding:9px 13px;font-family:'Pretendard',sans-serif;font-size:13px;color:var(--text);background:var(--white);outline:none;transition:border .2s;}
.form-row input:focus,.form-row select:focus,.form-row textarea:focus{border-color:var(--accent);}
.form-row textarea{height:130px;resize:vertical;}
.f2col{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.btn-primary{padding:9px 22px;background:var(--accent);color:#fff;border:none;border-radius:7px;font-family:'Pretendard',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:background .15s;}
.btn-primary:hover{background:var(--accent-h);}
.btn-secondary{padding:9px 20px;background:#fff;color:var(--text);border:1.5px solid var(--border);border-radius:7px;font-family:'Pretendard',sans-serif;font-size:13px;cursor:pointer;}
.btn-danger{padding:9px 22px;background:var(--red);color:#fff;border:none;border-radius:7px;font-family:'Pretendard',sans-serif;font-size:13px;font-weight:600;cursor:pointer;}
.warn-box{background:#fdf0ef;border:1px solid #f0c0bb;border-radius:8px;padding:12px 16px;font-size:13px;color:var(--red);margin-bottom:16px;line-height:1.6;}

/* TOAST */
#toast{position:fixed;bottom:24px;right:24px;background:var(--navy);color:#fff;padding:12px 18px;border-radius:8px;font-size:13px;font-weight:500;box-shadow:0 8px 24px rgba(0,0,0,.25);transform:translateY(60px);opacity:0;transition:all .25s ease;z-index:9999;pointer-events:none;}
#toast.show{transform:translateY(0);opacity:1;}
.srch-result-lbl{font-size:13px;color:var(--text-2);margin-bottom:14px;}
.srch-result-lbl strong{color:var(--accent);}

/* ADMIN */
.btn-login{padding:6px 14px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);border-radius:6px;color:rgba(255,255,255,.75);font-size:12px;font-family:'Pretendard',sans-serif;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:6px;}
.btn-login:hover{background:rgba(255,255,255,.22);color:#fff;}
.admin-bar{display:flex;align-items:center;gap:10px;}
.admin-badge{display:flex;align-items:center;gap:6px;padding:5px 12px;background:rgba(42,180,100,.2);border:1px solid rgba(42,180,100,.35);border-radius:6px;font-size:12px;color:#7ef5b0;font-weight:600;}
.admin-badge .dot{width:7px;height:7px;border-radius:50%;background:#4ade80;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.btn-logout{padding:5px 12px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:6px;color:rgba(255,255,255,.55);font-size:12px;font-family:'Pretendard',sans-serif;cursor:pointer;transition:all .15s;}
.btn-logout:hover{background:rgba(220,50,50,.25);border-color:rgba(220,50,50,.4);color:#fca5a5;}
.btn-admin-reg{padding:6px 14px;background:var(--accent);border:none;border-radius:6px;color:#fff;font-size:12px;font-weight:600;font-family:'Pretendard',sans-serif;cursor:pointer;transition:background .15s;}
.btn-admin-reg:hover{background:var(--accent-h);}
.pw-input-wrap{position:relative;}
.pw-input-wrap input{width:100%;border:1.5px solid var(--border);border-radius:7px;padding:10px 40px 10px 13px;font-family:'Pretendard',sans-serif;font-size:14px;color:var(--text);outline:none;transition:border .2s;}
.pw-input-wrap input:focus{border-color:var(--accent);}
.pw-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:15px;background:none;border:none;color:var(--text-3);}
.login-error{font-size:12px;color:var(--red);margin-top:6px;display:none;}
.login-error.show{display:block;}
</style>
</head>
<body>

<header id="header">
  <div class="header-logo" onclick="showHome()">
    <div class="logo-icon">ğŸ“‹</div>
    <div><div class="logo-text">ê·œì •ê´€ë¦¬ì‹œìŠ¤í…œ</div><div class="logo-sub">Regulation Management System</div></div>
  </div>
  <nav class="header-nav">
    <a id="nav-home" class="active" onclick="showHome()">í™ˆ</a>
    <a id="nav-law" onclick="showCategory(null)">ê·œì •ì •ë³´</a>
    <a id="nav-recent" onclick="showRecentView()">ìµœì‹  ì œÂ·ê°œì •</a>
  </nav>
  <div class="header-right" id="headerRight">
    <button class="btn-login" onclick="openLoginModal()">ğŸ”’ ê´€ë¦¬ì ë¡œê·¸ì¸</button>
  </div>
</header>

<div id="layout">
  <nav id="sidebar">
    <div class="sb-search-box">
      <div class="sb-search-wrap">
        <span class="sb-search-icon">ğŸ”</span>
        <input type="text" id="sbSearch" placeholder="ê·œì •ëª… ê²€ìƒ‰..." oninput="onSbSearch()">
      </div>
    </div>
    <div class="tree-section" id="treeSection"></div>
  </nav>
  <div id="main"><div id="content"></div></div>
</div>

<!-- FORM MODAL -->
<div class="modal-backdrop" id="formModal">
  <div class="modal">
    <div class="modal-hd">
      <div class="modal-ttl" id="modalTitle">ìƒˆ ê·œì • ë“±ë¡</div>
      <button class="modal-close" onclick="closeModal('formModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-row"><label>ê·œì •ëª… *</label><input type="text" id="fTitle" placeholder="ì˜ˆ: ì„ì§ì› í–‰ë™ê°•ë ¹"></div>
      <div class="f2col">
        <div class="form-row"><label>ëŒ€ë¶„ë¥˜ *</label>
          <select id="fGroup"><option value="">ì„ íƒ</option><option>í•™ì‚¬</option><option>ì¸ì‚¬</option><option>ì¬ë¬´</option><option>ITë³´ì•ˆ</option><option>ì¤€ë²•</option><option>ìš´ì˜</option><option>ê¸°íƒ€</option></select>
        </div>
        <div class="form-row"><label>ì†Œë¶„ë¥˜</label><input type="text" id="fCategory" placeholder="ì˜ˆ: êµì›ì¸ì‚¬"></div>
      </div>
      <div class="f2col">
        <div class="form-row"><label>ìƒíƒœ</label>
          <select id="fStatus"><option value="active">ì‹œí–‰ì¤‘</option><option value="draft">ì´ˆì•ˆ</option><option value="obsolete">íê¸°</option></select>
        </div>
        <div class="form-row"><label>ë²„ì „ *</label><input type="text" id="fVersion" placeholder="ì˜ˆ: v1.0"></div>
      </div>
      <div class="f2col">
        <div class="form-row"><label>ì‹œí–‰ì¼</label><input type="date" id="fDate"></div>
        <div class="form-row"><label>ë‹´ë‹¹ë¶€ì„œ</label><input type="text" id="fDept" placeholder="ì˜ˆ: ì´ë¬´íŒ€"></div>
      </div>
      <div class="form-row"><label>ê·œì • ë‚´ìš© *</label><textarea id="fBody" placeholder="ê·œì •ì˜ ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea></div>
      <div class="form-row" id="fRevRow" style="display:none"><label>ê°œì • ì‚¬ìœ </label><input type="text" id="fRevNote" placeholder="ì´ë²ˆ ê°œì •ì˜ ì£¼ìš” ë³€ê²½ ë‚´ìš©"></div>
    </div>
    <div class="modal-ft">
      <button class="btn-secondary" onclick="closeModal('formModal')">ì·¨ì†Œ</button>
      <button class="btn-primary" onclick="saveReg()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="modal-backdrop" id="deleteModal">
  <div class="modal sm">
    <div class="modal-hd">
      <div class="modal-ttl">ê·œì • ì‚­ì œ</div>
      <button class="modal-close" onclick="closeModal('deleteModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="warn-box">âš ï¸ ì‚­ì œí•˜ë©´ ëª¨ë“  ê°œì • ì´ë ¥ì´ í•¨ê»˜ ì‚­ì œë˜ë©°, ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
      <p style="font-size:14px;color:var(--text-2)"><strong id="deleteTargetName"></strong> ê·œì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    </div>
    <div class="modal-ft">
      <button class="btn-secondary" onclick="closeModal('deleteModal')">ì·¨ì†Œ</button>
      <button class="btn-danger" onclick="confirmDelete()">ì‚­ì œ</button>
    </div>
  </div>
</div>


<!-- LOGIN MODAL -->
<div class="modal-backdrop" id="loginModal">
  <div class="modal sm">
    <div class="modal-hd">
      <div class="modal-ttl">ğŸ”’ ê´€ë¦¬ì ë¡œê·¸ì¸</div>
      <button class="modal-close" onclick="closeModal('loginModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text-2);margin-bottom:18px;line-height:1.7;">
        ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ ê·œì • ë“±ë¡Â·ìˆ˜ì •Â·ì‚­ì œ ê¸°ëŠ¥ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
      </p>
      <div class="form-row">
        <label>ë¹„ë°€ë²ˆí˜¸</label>
        <div class="pw-input-wrap">
          <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeydown="if(event.key==='Enter')doLogin()">
          <button class="pw-toggle" onclick="togglePw()" tabindex="-1">ğŸ‘</button>
        </div>
        <div class="login-error" id="loginError">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn-secondary" onclick="closeModal('loginModal')">ì·¨ì†Œ</button>
      <button class="btn-primary" onclick="doLogin()">ë¡œê·¸ì¸</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â‘  ì—¬ê¸°ì— Supabase í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”
const SUPABASE_URL = 'https://wcjymtpobpveaawnalqw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndjanltdHBvYnB2ZWFhd25hbHF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTI5NjMsImV4cCI6MjA4Nzc2ODk2M30._FGF2omzLKX33bdBE_LQGrme_4R_WOJ6WebU2E3JXOU';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _supabase = null;
function getSupabase() {
  if (!_supabase && SUPABASE_URL !== 'https://wcjymtpobpveaawnalqw.supabase.co') {
    _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }
  return _supabase;
}

// â”€â”€ STORAGE (localStorage í´ë°± + Supabase) â”€â”€
const Storage = {
  load(){ try{ return JSON.parse(localStorage.getItem('regbook_v3')||'[]'); }catch{ return []; } },
  save(d){ localStorage.setItem('regbook_v3', JSON.stringify(d)); },

  // Supabase: ì „ì²´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  async fetchAll() {
    const sb = getSupabase(); if (!sb) return null;
    const { data, error } = await sb.from('regulations').select('*').order('updated_at', { ascending: false });
    if (error) { console.error(error); return null; }
    return data.map(r => ({
      id: r.id, title: r.title, group: r.group_name,
      category: r.category, status: r.status, version: r.version,
      date: r.date, dept: r.dept, body: r.body,
      history: r.history || []
    }));
  },

  // Supabase: ì €ì¥(upsert)
  async upsert(reg) {
    const sb = getSupabase(); if (!sb) return false;
    const { error } = await sb.from('regulations').upsert({
      id: reg.id, title: reg.title, group_name: reg.group,
      category: reg.category, status: reg.status, version: reg.version,
      date: reg.date, dept: reg.dept, body: reg.body,
      history: reg.history, updated_at: new Date().toISOString()
    });
    if (error) { console.error(error); return false; }
    return true;
  },

  // Supabase: ì‚­ì œ
  async remove(id) {
    const sb = getSupabase(); if (!sb) return false;
    const { error } = await sb.from('regulations').delete().eq('id', id);
    if (error) { console.error(error); return false; }
    return true;
  }
};

let regs = Storage.load();

// Supabase ì—°ê²°ëœ ê²½ìš° DBì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
async function initData() {
  const sbData = await Storage.fetchAll();
  if (sbData && sbData.length > 0) {
    regs = sbData;
    Storage.save(regs); // ë¡œì»¬ ìºì‹œ ê°±ì‹ 
  } else if (sbData && sbData.length === 0 && getSupabase()) {
    // DB ì—°ê²°ëì§€ë§Œ ë°ì´í„° ì—†ìœ¼ë©´ ìƒ˜í”Œ ë°ì´í„° ì—…ë¡œë“œ
    for (const r of regs) await Storage.upsert(r);
    showToast('âœ… ìƒ˜í”Œ ë°ì´í„°ë¥¼ DBì— ì €ì¥í–ˆìŠµë‹ˆë‹¤');
  }
  showHome();
  buildTree();
}
let currentView = 'home';
let currentGroup = null;
let currentCat = null;
let currentId = null;
let editMode = false;
let deleteTargetId = null;
let treeOpen = new Set(['í•™ì‚¬','ì¸ì‚¬','ì¬ë¬´','ITë³´ì•ˆ']);
const GROUPS = ['í•™ì‚¬','ì¸ì‚¬','ì¬ë¬´','ITë³´ì•ˆ','ì¤€ë²•','ìš´ì˜','ê¸°íƒ€'];

// â”€â”€ ê´€ë¦¬ì ì¸ì¦ â”€â”€
// TODO: Supabase ì—°ë™ ì‹œ doLogin() í•¨ìˆ˜ë§Œ êµì²´í•˜ë©´ ë©ë‹ˆë‹¤.
let isAdmin = false;
const ADMIN_PW = 'admin1234'; // â† ë¹„ë°€ë²ˆí˜¸ ì—¬ê¸°ì„œ ë³€ê²½

function openLoginModal() {
  document.getElementById('loginPw').value = '';
  document.getElementById('loginError').classList.remove('show');
  openModal('loginModal');
  setTimeout(()=>document.getElementById('loginPw').focus(), 100);
}

function doLogin() {
  const pw = document.getElementById('loginPw').value;
  if (pw === ADMIN_PW) {
    isAdmin = true;
    closeModal('loginModal');
    updateAdminUI();
    showToast('âœ… ê´€ë¦¬ì ëª¨ë“œë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤');
    if (currentView==='detail'&&currentId) showDetail(currentId);
    else if (currentView==='list') showCategory(currentGroup, currentCat);
    else showHome();
  } else {
    document.getElementById('loginError').classList.add('show');
    document.getElementById('loginPw').focus();
  }
}

function doLogout() {
  isAdmin = false;
  updateAdminUI();
  showToast('ğŸ”’ ê´€ë¦¬ì ëª¨ë“œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  if (currentView==='detail'&&currentId) showDetail(currentId);
  else if (currentView==='list') showCategory(currentGroup, currentCat);
  else showHome();
}

function togglePw() {
  const inp = document.getElementById('loginPw');
  inp.type = inp.type==='password' ? 'text' : 'password';
}

function updateAdminUI() {
  const el = document.getElementById('headerRight');
  if (isAdmin) {
    el.innerHTML = `
      <div class="admin-bar">
        <div class="admin-badge"><span class="dot"></span>ê´€ë¦¬ì ëª¨ë“œ</div>
        <button class="btn-admin-reg" onclick="openCreateModal()">ï¼‹ ê·œì • ë“±ë¡</button>
        <button class="btn-logout" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>`;
  } else {
    el.innerHTML = `<button class="btn-login" onclick="openLoginModal()">ğŸ”’ ê´€ë¦¬ì ë¡œê·¸ì¸</button>`;
  }
}

// â”€â”€ SAMPLE DATA â”€â”€
if (!regs.length) {
  regs = [
    {id:'r1',title:'í•™ì‚¬ê·œì •',group:'í•™ì‚¬',category:'í•™ì‚¬ì¼ë°˜',status:'active',version:'v3.2',date:'2026-03-01',dept:'êµë¬´ì²˜',
     body:'ì œ1ì¡°(ëª©ì )\nì´ ê·œì •ì€ í•™ì‚¬ ìš´ì˜ì— ê´€í•œ ê¸°ë³¸ ì‚¬í•­ì„ ì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•œë‹¤.\n\nì œ2ì¡°(ì ìš©ë²”ìœ„)\nì´ ê·œì •ì€ ì¬í•™ìƒ ì „ì›ì—ê²Œ ì ìš©í•œë‹¤.\n\nì œ3ì¡°(í•™ì ì´ìˆ˜)\nì¡¸ì—…ì„ ìœ„í•´ì„œëŠ” ì´ 130í•™ì  ì´ìƒì„ ì·¨ë“í•˜ì—¬ì•¼ í•œë‹¤.\n\nì œ4ì¡°(ìˆ˜ì—…ì—°í•œ)\ní•™ì‚¬í•™ìœ„ ê³¼ì •ì˜ ìˆ˜ì—…ì—°í•œì€ 4ë…„ìœ¼ë¡œ í•œë‹¤.',
     history:[
       {version:'v1.0',date:'2018-03-01',note:'ìµœì´ˆ ì œì •',body:'ì œ1ì¡°(ëª©ì )\nì´ ê·œì •ì€ í•™ì‚¬ ìš´ì˜ì— ê´€í•œ ê¸°ë³¸ ì‚¬í•­ì„ ì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•œë‹¤.\n\nì œ2ì¡°(ì ìš©ë²”ìœ„)\nì´ ê·œì •ì€ ì¬í•™ìƒ ì „ì›ì—ê²Œ ì ìš©í•œë‹¤.\n\nì œ3ì¡°(í•™ì ì´ìˆ˜)\nì¡¸ì—…ì„ ìœ„í•´ì„œëŠ” ì´ 120í•™ì  ì´ìƒì„ ì·¨ë“í•˜ì—¬ì•¼ í•œë‹¤.\n\nì œ4ì¡°(ìˆ˜ì—…ì—°í•œ)\ní•™ì‚¬í•™ìœ„ ê³¼ì •ì˜ ìˆ˜ì—…ì—°í•œì€ 4ë…„ìœ¼ë¡œ í•œë‹¤.'},
       {version:'v2.0',date:'2022-03-01',note:'ë¹„ëŒ€ë©´ ìˆ˜ì—… ì¡°í•­ ì‹ ì„¤',body:'ì œ1ì¡°(ëª©ì )\nì´ ê·œì •ì€ í•™ì‚¬ ìš´ì˜ì— ê´€í•œ ê¸°ë³¸ ì‚¬í•­ì„ ì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•œë‹¤.\n\nì œ2ì¡°(ì ìš©ë²”ìœ„)\nì´ ê·œì •ì€ ì¬í•™ìƒ ì „ì›ì—ê²Œ ì ìš©í•œë‹¤.\n\nì œ3ì¡°(í•™ì ì´ìˆ˜)\nì¡¸ì—…ì„ ìœ„í•´ì„œëŠ” ì´ 125í•™ì  ì´ìƒì„ ì·¨ë“í•˜ì—¬ì•¼ í•œë‹¤.\n\nì œ4ì¡°(ìˆ˜ì—…ì—°í•œ)\ní•™ì‚¬í•™ìœ„ ê³¼ì •ì˜ ìˆ˜ì—…ì—°í•œì€ 4ë…„ìœ¼ë¡œ í•œë‹¤.\n\nì œ5ì¡°(ë¹„ëŒ€ë©´ìˆ˜ì—…)\në¹„ëŒ€ë©´ ìˆ˜ì—…ì€ ì „ì²´ í•™ì ì˜ 20% ì´ë‚´ë¡œ ì œí•œí•œë‹¤.'},
       {version:'v3.0',date:'2025-01-01',note:'í•™ì ì¸ì • ê¸°ì¤€ ê°œì •',body:'ì œ1ì¡°(ëª©ì )\nì´ ê·œì •ì€ í•™ì‚¬ ìš´ì˜ì— ê´€í•œ ê¸°ë³¸ ì‚¬í•­ì„ ì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•œë‹¤.\n\nì œ2ì¡°(ì ìš©ë²”ìœ„)\nì´ ê·œì •ì€ ì¬í•™ìƒ ì „ì›ì—ê²Œ ì ìš©í•œë‹¤.\n\nì œ3ì¡°(í•™ì ì´ìˆ˜)\nì¡¸ì—…ì„ ìœ„í•´ì„œëŠ” ì´ 130í•™ì  ì´ìƒì„ ì·¨ë“í•˜ì—¬ì•¼ í•œë‹¤.\n\nì œ4ì¡°(ìˆ˜ì—…ì—°í•œ)\ní•™ì‚¬í•™ìœ„ ê³¼ì •ì˜ ìˆ˜ì—…ì—°í•œì€ 4ë…„ìœ¼ë¡œ í•œë‹¤.'},
       {version:'v3.2',date:'2026-03-01',note:'ì¡¸ì—…í•™ì  ê¸°ì¤€ ì¡°ì •',body:'ì œ1ì¡°(ëª©ì )\nì´ ê·œì •ì€ í•™ì‚¬ ìš´ì˜ì— ê´€í•œ ê¸°ë³¸ ì‚¬í•­ì„ ì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•œë‹¤.\n\nì œ2ì¡°(ì ìš©ë²”ìœ„)\nì´ ê·œì •ì€ ì¬í•™ìƒ ì „ì›ì—ê²Œ ì ìš©í•œë‹¤.\n\nì œ3ì¡°(í•™ì ì´ìˆ˜)\nì¡¸ì—…ì„ ìœ„í•´ì„œëŠ” ì´ 130í•™ì  ì´ìƒì„ ì·¨ë“í•˜ì—¬ì•¼ í•œë‹¤.\n\nì œ4ì¡°(ìˆ˜ì—…ì—°í•œ)\ní•™ì‚¬í•™ìœ„ ê³¼ì •ì˜ ìˆ˜ì—…ì—°í•œì€ 4ë…„ìœ¼ë¡œ í•œë‹¤.'}
     ]},
    {id:'r2',title:'êµì›ì¸ì‚¬ê·œì •',group:'ì¸ì‚¬',category:'êµì›',status:'active',version:'v2.0',date:'2025-09-01',dept:'ì¸ì‚¬ì²˜',
     body:'ì œ1ì¡°(ëª©ì )\në³¸ ê·œì •ì€ êµì›ì˜ ì„ìš©, ìŠ¹ì§„, ë³´ì§ ë“± ì¸ì‚¬ì— ê´€í•œ ì‚¬í•­ì„ ê·œì •í•œë‹¤.\n\nì œ2ì¡°(ì„ìš©)\nêµì›ì€ ê³µê°œ ì±„ìš©ì„ ì›ì¹™ìœ¼ë¡œ í•œë‹¤.\n\nì œ3ì¡°(ì •ë…„)\nêµì›ì˜ ì •ë…„ì€ ë§Œ 65ì„¸ë¡œ í•œë‹¤.',
     history:[
       {version:'v1.0',date:'2020-01-01',note:'ìµœì´ˆ ì œì •',body:'ì œ1ì¡°(ëª©ì )\në³¸ ê·œì •ì€ êµì›ì˜ ì„ìš©, ìŠ¹ì§„, ë³´ì§ ë“± ì¸ì‚¬ì— ê´€í•œ ì‚¬í•­ì„ ê·œì •í•œë‹¤.\n\nì œ2ì¡°(ì„ìš©)\nêµì›ì€ ê³µê°œ ì±„ìš©ì„ ì›ì¹™ìœ¼ë¡œ í•œë‹¤.\n\nì œ3ì¡°(ì •ë…„)\nêµì›ì˜ ì •ë…„ì€ ë§Œ 63ì„¸ë¡œ í•œë‹¤.'},
       {version:'v2.0',date:'2025-09-01',note:'ì •ë…„ ì—°ì¥ ë° ì±„ìš© ì ˆì°¨ ê°œì •',body:'ì œ1ì¡°(ëª©ì )\në³¸ ê·œì •ì€ êµì›ì˜ ì„ìš©, ìŠ¹ì§„, ë³´ì§ ë“± ì¸ì‚¬ì— ê´€í•œ ì‚¬í•­ì„ ê·œì •í•œë‹¤.\n\nì œ2ì¡°(ì„ìš©)\nêµì›ì€ ê³µê°œ ì±„ìš©ì„ ì›ì¹™ìœ¼ë¡œ í•œë‹¤.\n\nì œ3ì¡°(ì •ë…„)\nêµì›ì˜ ì •ë…„ì€ ë§Œ 65ì„¸ë¡œ í•œë‹¤.'}
     ]},
    {id:'r3',title:'ì§ì›ë³µë¬´ê·œì •',group:'ì¸ì‚¬',category:'ì§ì›',status:'active',version:'v1.5',date:'2024-01-01',dept:'ì´ë¬´ì²˜',
     body:'ì œ1ì¡°(ëª©ì )\nì§ì›ì˜ ë³µë¬´ì— ê´€í•œ ì‚¬í•­ì„ ì •í•œë‹¤.\n\nì œ2ì¡°(ê·¼ë¬´ì‹œê°„)\nì§ì›ì˜ ê·¼ë¬´ì‹œê°„ì€ ì˜¤ì „ 9ì‹œë¶€í„° ì˜¤í›„ 6ì‹œê¹Œì§€ë¡œ í•œë‹¤.\n\nì œ3ì¡°(ì—°ì°¨íœ´ê°€)\nì§ì›ì€ ê·¼ì†ì—°ìˆ˜ì— ë”°ë¼ ì—°ì°¨íœ´ê°€ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.\n\nì œ4ì¡°(ì¬íƒê·¼ë¬´)\nì¬íƒê·¼ë¬´ëŠ” ì£¼ 2ì¼ ì´ë‚´ì—ì„œ í—ˆìš©í•œë‹¤.',
     history:[
       {version:'v1.0',date:'2021-01-01',note:'ìµœì´ˆ ì œì •',body:'ì œ1ì¡°(ëª©ì )\nì§ì›ì˜ ë³µë¬´ì— ê´€í•œ ì‚¬í•­ì„ ì •í•œë‹¤.\n\nì œ2ì¡°(ê·¼ë¬´ì‹œê°„)\nì§ì›ì˜ ê·¼ë¬´ì‹œê°„ì€ ì˜¤ì „ 9ì‹œë¶€í„° ì˜¤í›„ 6ì‹œê¹Œì§€ë¡œ í•œë‹¤.\n\nì œ3ì¡°(ì—°ì°¨íœ´ê°€)\nì§ì›ì€ ê·¼ì†ì—°ìˆ˜ì— ë”°ë¼ ì—°ì°¨íœ´ê°€ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.'},
       {version:'v1.5',date:'2024-01-01',note:'ì¬íƒê·¼ë¬´ ì¡°í•­ ì¶”ê°€',body:'ì œ1ì¡°(ëª©ì )\nì§ì›ì˜ ë³µë¬´ì— ê´€í•œ ì‚¬í•­ì„ ì •í•œë‹¤.\n\nì œ2ì¡°(ê·¼ë¬´ì‹œê°„)\nì§ì›ì˜ ê·¼ë¬´ì‹œê°„ì€ ì˜¤ì „ 9ì‹œë¶€í„° ì˜¤í›„ 6ì‹œê¹Œì§€ë¡œ í•œë‹¤.\n\nì œ3ì¡°(ì—°ì°¨íœ´ê°€)\nì§ì›ì€ ê·¼ì†ì—°ìˆ˜ì— ë”°ë¼ ì—°ì°¨íœ´ê°€ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.\n\nì œ4ì¡°(ì¬íƒê·¼ë¬´)\nì¬íƒê·¼ë¬´ëŠ” ì£¼ 2ì¼ ì´ë‚´ì—ì„œ í—ˆìš©í•œë‹¤.'}
     ]},
    {id:'r4',title:'ì˜ˆì‚°í¸ì„± ë° ì§‘í–‰ê·œì •',group:'ì¬ë¬´',category:'ì˜ˆì‚°',status:'active',version:'v2.1',date:'2025-01-01',dept:'ì¬ë¬´ì²˜',
     body:'ì œ1ì¡°(ëª©ì )\nì˜ˆì‚°ì˜ í¸ì„±, ë°°ì •, ì§‘í–‰ì— ê´€í•œ ì‚¬í•­ì„ ì •í•œë‹¤.\n\nì œ2ì¡°(ì˜ˆì‚°í¸ì„±)\nê° ë¶€ì„œëŠ” ë§¤ë…„ 10ì›”ë§ê¹Œì§€ ë‹¤ìŒ ì—°ë„ ì˜ˆì‚°ì•ˆì„ ì œì¶œí•˜ì—¬ì•¼ í•œë‹¤.\n\nì œ3ì¡°(ì§‘í–‰í•œë„)\níŒ€ì¥ ì „ê²° í•œë„ëŠ” 500ë§Œì›ìœ¼ë¡œ í•œë‹¤.',
     history:[
       {version:'v1.0',date:'2019-01-01',note:'ìµœì´ˆ ì œì •',body:'ì œ1ì¡°(ëª©ì )\nì˜ˆì‚°ì˜ í¸ì„±, ë°°ì •, ì§‘í–‰ì— ê´€í•œ ì‚¬í•­ì„ ì •í•œë‹¤.\n\nì œ2ì¡°(ì˜ˆì‚°í¸ì„±)\nê° ë¶€ì„œëŠ” ë§¤ë…„ 10ì›”ë§ê¹Œì§€ ë‹¤ìŒ ì—°ë„ ì˜ˆì‚°ì•ˆì„ ì œì¶œí•˜ì—¬ì•¼ í•œë‹¤.\n\nì œ3ì¡°(ì§‘í–‰í•œë„)\níŒ€ì¥ ì „ê²° í•œë„ëŠ” 300ë§Œì›ìœ¼ë¡œ í•œë‹¤.'},
       {version:'v2.0',date:'2023-01-01',note:'ì „ë©´ ê°œì •',body:'ì œ1ì¡°(ëª©ì )\nì˜ˆì‚°ì˜ í¸ì„±, ë°°ì •, ì§‘í–‰ì— ê´€í•œ ì‚¬í•­ì„ ì •í•œë‹¤.\n\nì œ2ì¡°(ì˜ˆì‚°í¸ì„±)\nê° ë¶€ì„œëŠ” ë§¤ë…„ 10ì›”ë§ê¹Œì§€ ë‹¤ìŒ ì—°ë„ ì˜ˆì‚°ì•ˆì„ ì œì¶œí•˜ì—¬ì•¼ í•œë‹¤.\n\nì œ3ì¡°(ì§‘í–‰í•œë„)\níŒ€ì¥ ì „ê²° í•œë„ëŠ” 400ë§Œì›ìœ¼ë¡œ í•œë‹¤.'},
       {version:'v2.1',date:'2025-01-01',note:'ì§‘í–‰ í•œë„ ì¡°ì •',body:'ì œ1ì¡°(ëª©ì )\nì˜ˆì‚°ì˜ í¸ì„±, ë°°ì •, ì§‘í–‰ì— ê´€í•œ ì‚¬í•­ì„ ì •í•œë‹¤.\n\nì œ2ì¡°(ì˜ˆì‚°í¸ì„±)\nê° ë¶€ì„œëŠ” ë§¤ë…„ 10ì›”ë§ê¹Œì§€ ë‹¤ìŒ ì—°ë„ ì˜ˆì‚°ì•ˆì„ ì œì¶œí•˜ì—¬ì•¼ í•œë‹¤.\n\nì œ3ì¡°(ì§‘í–‰í•œë„)\níŒ€ì¥ ì „ê²° í•œë„ëŠ” 500ë§Œì›ìœ¼ë¡œ í•œë‹¤.'}
     ]},
    {id:'r5',title:'ì •ë³´ë³´ì•ˆ ê´€ë¦¬ê·œì •',group:'ITë³´ì•ˆ',category:'ë³´ì•ˆ',status:'active',version:'v3.0',date:'2025-06-01',dept:'ì •ë³´ì „ì‚°ì²˜',
     body:'ì œ1ì¡°(ëª©ì )\nì •ë³´ìì‚° ë³´í˜¸ ë° ë³´ì•ˆ ì‚¬ê³  ì˜ˆë°©ì„ ìœ„í•œ ê´€ë¦¬ ê¸°ì¤€ì„ ì •í•œë‹¤.\n\nì œ2ì¡°(ì ìš©ë²”ìœ„)\nëª¨ë“  ì •ë³´ì‹œìŠ¤í…œ ë° ì´ìš©ìì—ê²Œ ì ìš©ëœë‹¤.\n\nì œ3ì¡°(ì ‘ê·¼í†µì œ)\nì •ë³´ì‹œìŠ¤í…œ ì ‘ê·¼ì€ ìµœì†Œ ê¶Œí•œ ì›ì¹™ì— ë”°ë¥¸ë‹¤.\n\nì œ4ì¡°(AIë³´ì•ˆ)\nAI ë„êµ¬ í™œìš© ì‹œ ë°ì´í„° ì™¸ë¶€ ì „ì†¡ì„ ê¸ˆì§€í•œë‹¤.',
     history:[
       {version:'v1.0',date:'2019-01-01',note:'ìµœì´ˆ ì œì •',body:'ì œ1ì¡°(ëª©ì )\nì •ë³´ìì‚° ë³´í˜¸ ë° ë³´ì•ˆ ì‚¬ê³  ì˜ˆë°©ì„ ìœ„í•œ ê´€ë¦¬ ê¸°ì¤€ì„ ì •í•œë‹¤.\n\nì œ2ì¡°(ì ìš©ë²”ìœ„)\nëª¨ë“  ì •ë³´ì‹œìŠ¤í…œ ë° ì´ìš©ìì—ê²Œ ì ìš©ëœë‹¤.\n\nì œ3ì¡°(ì ‘ê·¼í†µì œ)\nì •ë³´ì‹œìŠ¤í…œ ì ‘ê·¼ì€ ìµœì†Œ ê¶Œí•œ ì›ì¹™ì— ë”°ë¥¸ë‹¤.'},
       {version:'v2.0',date:'2022-06-01',note:'í´ë¼ìš°ë“œ ë³´ì•ˆ ì¡°í•­ ì¶”ê°€',body:'ì œ1ì¡°(ëª©ì )\nì •ë³´ìì‚° ë³´í˜¸ ë° ë³´ì•ˆ ì‚¬ê³  ì˜ˆë°©ì„ ìœ„í•œ ê´€ë¦¬ ê¸°ì¤€ì„ ì •í•œë‹¤.\n\nì œ2ì¡°(ì ìš©ë²”ìœ„)\nëª¨ë“  ì •ë³´ì‹œìŠ¤í…œ ë° ì´ìš©ìì—ê²Œ ì ìš©ëœë‹¤.\n\nì œ3ì¡°(ì ‘ê·¼í†µì œ)\nì •ë³´ì‹œìŠ¤í…œ ì ‘ê·¼ì€ ìµœì†Œ ê¶Œí•œ ì›ì¹™ì— ë”°ë¥¸ë‹¤.\n\nì œ4ì¡°(í´ë¼ìš°ë“œë³´ì•ˆ)\ní´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ì´ìš© ì‹œ ë³´ì•ˆ ì ê²€ì„ ì˜ë¬´í™”í•œë‹¤.'},
       {version:'v3.0',date:'2025-06-01',note:'AI í™œìš© ë³´ì•ˆ ì§€ì¹¨ ì‹ ì„¤',body:'ì œ1ì¡°(ëª©ì )\nì •ë³´ìì‚° ë³´í˜¸ ë° ë³´ì•ˆ ì‚¬ê³  ì˜ˆë°©ì„ ìœ„í•œ ê´€ë¦¬ ê¸°ì¤€ì„ ì •í•œë‹¤.\n\nì œ2ì¡°(ì ìš©ë²”ìœ„)\nëª¨ë“  ì •ë³´ì‹œìŠ¤í…œ ë° ì´ìš©ìì—ê²Œ ì ìš©ëœë‹¤.\n\nì œ3ì¡°(ì ‘ê·¼í†µì œ)\nì •ë³´ì‹œìŠ¤í…œ ì ‘ê·¼ì€ ìµœì†Œ ê¶Œí•œ ì›ì¹™ì— ë”°ë¥¸ë‹¤.\n\nì œ4ì¡°(AIë³´ì•ˆ)\nAI ë„êµ¬ í™œìš© ì‹œ ë°ì´í„° ì™¸ë¶€ ì „ì†¡ì„ ê¸ˆì§€í•œë‹¤.'}
     ]},
  ];
  Storage.save(regs);
}

// â”€â”€ TREE â”€â”€
function buildTree() {
  const sec = document.getElementById('treeSection');
  sec.innerHTML = '';
  const allEl = document.createElement('div');
  allEl.className = 'tree-item' + (currentView==='list'&&!currentGroup?' active':'');
  allEl.innerHTML = `<span class="tree-icon">ğŸ“‚</span>ì „ì²´ ê·œì •<span class="tree-cnt">${regs.length}</span>`;
  allEl.onclick = () => { currentCat=null; showCategory(null); };
  sec.appendChild(allEl);
  GROUPS.forEach(g => {
    const items = regs.filter(r=>r.group===g);
    if (!items.length) return;
    const isOpen = treeOpen.has(g);
    const hd = document.createElement('div');
    hd.className = 'tree-group-hd'+(isOpen?' open':'');
    hd.innerHTML = `<span class="tree-arrow">â–¶</span>${g}<span class="tree-cnt" style="margin-left:auto">${items.length}</span>`;
    hd.onclick = () => { isOpen?treeOpen.delete(g):treeOpen.add(g); buildTree(); };
    sec.appendChild(hd);
    const ch = document.createElement('div');
    ch.className = 'tree-children'+(isOpen?' open':'');
    const gAll = document.createElement('div');
    gAll.className = 'tree-item'+(currentView==='list'&&currentGroup===g&&!currentCat?' active':'');
    gAll.innerHTML = `<span class="tree-icon">ğŸ“</span>ì „ì²´<span class="tree-cnt">${items.length}</span>`;
    gAll.onclick = () => { currentCat=null; showCategory(g); };
    ch.appendChild(gAll);
    const cats = [...new Set(items.map(r=>r.category).filter(Boolean))];
    cats.forEach(cat => {
      const cnt = items.filter(r=>r.category===cat).length;
      const ci = document.createElement('div');
      ci.className = 'tree-item'+(currentView==='list'&&currentGroup===g&&currentCat===cat?' active':'');
      ci.style.paddingLeft = '36px';
      ci.innerHTML = `<span class="tree-icon" style="opacity:.4">â””</span>${cat}<span class="tree-cnt">${cnt}</span>`;
      ci.onclick = () => { currentCat=cat; showCategory(g,cat); };
      ch.appendChild(ci);
    });
    sec.appendChild(ch);
  });
}

// â”€â”€ VIEWS â”€â”€
function setNav(id) {
  document.querySelectorAll('.header-nav a').forEach(a=>a.classList.remove('active'));
  if(id) document.getElementById(id).classList.add('active');
}

function showHome() {
  currentView='home'; currentGroup=null; currentCat=null; currentId=null;
  setNav('nav-home'); buildTree();
  const recent = [...regs].sort((a,b)=>(b.history.at(-1)?.date||'').localeCompare(a.history.at(-1)?.date||'')).slice(0,10);
  document.getElementById('content').innerHTML = `
    <div class="home-search-bar">
      <h2>ğŸ” ê·œì • í†µí•©ê²€ìƒ‰</h2>
      <div class="search-row">
        <select class="search-type" id="hsType"><option value="title">ê·œì •ëª…</option><option value="body">ê·œì •ë‚´ìš©</option></select>
        <input class="search-inp" type="text" id="hsInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeydown="if(event.key==='Enter')doSearch()">
        <button class="btn-srch" onclick="doSearch()">ê²€ìƒ‰</button>
      </div>
    </div>
    <div class="view-hd" style="margin-bottom:14px">
      <div class="view-ttl" style="font-size:16px">ğŸ†• ìµœì‹  ì œÂ·ê°œì • ê·œì •</div>
    </div>
    <div class="reg-table"><table>
      <thead><tr>
        <th style="width:6%">êµ¬ë¶„</th><th style="width:34%">ê·œì •ëª…</th>
        <th>ë¶„ë¥˜</th><th>ì‹œí–‰ì¼</th><th>ê´€ë¦¬ë¶€ì„œ</th>
      </tr></thead>
      <tbody>${recent.map(r=>{
        const last=r.history.at(-1);
        const isNew=r.history.length===1;
        const tc=isNew?'rtype-new':r.status==='obsolete'?'rtype-obs':'rtype-rev';
        const tl=isNew?'ì œì •':r.status==='obsolete'?'íê¸°':'ê°œì •';
        return `<tr onclick="showDetail('${r.id}')">
          <td><span class="rtype ${tc}">${tl}</span></td>
          <td class="td-ttl">${r.title}</td>
          <td style="font-size:12px;color:var(--text-3)">${r.group}${r.category?' â€º '+r.category:''}</td>
          <td style="font-size:12px;color:var(--text-3);font-family:'DM Mono',monospace">${last?.date||'â€”'}</td>
          <td style="font-size:12px;color:var(--text-2)">${r.dept||'â€”'}</td>
        </tr>`;
      }).join('')}</tbody>
    </table></div>`;
}

function showCategory(group, cat) {
  currentView='list'; currentGroup=group;
  if(cat!==undefined) currentCat=cat;
  setNav('nav-law'); buildTree();
  let filtered = regs;
  if(group) filtered = filtered.filter(r=>r.group===group);
  if(currentCat) filtered = filtered.filter(r=>r.category===currentCat);
  const label = group?(currentCat?`${group} â€º ${currentCat}`:group):'ì „ì²´ ê·œì •';
  document.getElementById('content').innerHTML = `
    <div class="view-hd">
      <div class="view-ttl">ğŸ“‚ ${label} <span class="cat-badge">${filtered.length}ê±´</span></div>
      ${isAdmin ? `<button class="btn-new-reg" onclick="openCreateModal()">ï¼‹ ê·œì • ë“±ë¡</button>` : ''}
    </div>
    ${filtered.length===0?'<div class="reg-table"><div class="empty-tbl">ë“±ë¡ëœ ê·œì •ì´ ì—†ìŠµë‹ˆë‹¤</div></div>':
    `<div class="reg-table"><table>
      <thead><tr>
        <th style="width:36%">ê·œì •ëª…</th><th style="width:12%">ë¶„ë¥˜</th>
        <th style="width:10%">ìƒíƒœ</th>
        <th style="width:14%">ì‹œí–‰ì¼</th><th>ë‹´ë‹¹ë¶€ì„œ</th>
      </tr></thead>
      <tbody>${filtered.map(r=>`<tr onclick="showDetail('${r.id}')">
        <td class="td-ttl">${r.title}</td>
        <td style="font-size:12px;color:var(--text-3)">${r.group}${r.category?' â€º '+r.category:''}</td>
        <td>${sBadge(r.status)}</td>
        <td style="font-size:12px;color:var(--text-3)">${r.date||'â€”'}</td>
        <td style="font-size:12px;color:var(--text-3)">${r.dept||'â€”'}</td>
      </tr>`).join('')}</tbody>
    </table></div>`}`;
}

function showRecentView() {
  currentView='recent'; currentGroup=null; currentCat=null; currentId=null;
  setNav('nav-recent'); buildTree();
  const sorted = [...regs].sort((a,b)=>(b.history.at(-1)?.date||'').localeCompare(a.history.at(-1)?.date||''));
  document.getElementById('content').innerHTML = `
    <div class="view-hd"><div class="view-ttl">ğŸ†• ìµœì‹  ì œÂ·ê°œì • ê·œì •</div></div>
    <div class="reg-table"><table>
      <thead><tr><th style="width:6%">êµ¬ë¶„</th><th style="width:34%">ê·œì •ëª…</th><th>ë¶„ë¥˜</th><th>ì‹œí–‰ì¼</th><th>ê´€ë¦¬ë¶€ì„œ</th></tr></thead>
      <tbody>${sorted.map(r=>{
        const last=r.history.at(-1);
        const isNew=r.history.length===1;
        const tc=isNew?'rtype-new':r.status==='obsolete'?'rtype-obs':'rtype-rev';
        const tl=isNew?'ì œì •':r.status==='obsolete'?'íê¸°':'ê°œì •';
        return `<tr onclick="showDetail('${r.id}')">
          <td><span class="rtype ${tc}">${tl}</span></td>
          <td class="td-ttl">${r.title}</td>
          <td style="font-size:12px;color:var(--text-3)">${r.group}</td>
          <td style="font-size:12px;color:var(--text-3);font-family:'DM Mono',monospace">${last?.date||'â€”'}</td>
          <td style="font-size:12px;color:var(--text-2)">${r.dept||'â€”'}</td>
        </tr>`;
      }).join('')}</tbody>
    </table></div>`;
}

function showDetail(id) {
  currentView='detail'; currentId=id;
  const reg=regs.find(r=>r.id===id); if(!reg) return;
  setNav(null); buildTree();
  const canDiff = reg.history.length >= 2;
  document.getElementById('content').innerHTML = `
    <div class="breadcrumb">
      <span class="bc-link" onclick="showHome()">í™ˆ</span> â€º
      <span class="bc-link" onclick="currentCat=null;showCategory('${reg.group}')">${reg.group}</span>
      ${reg.category?`â€º <span class="bc-link" onclick="showCategory('${reg.group}','${reg.category}')">${reg.category}</span>`:''}
      â€º ${reg.title}
    </div>
    <div class="detail-card">
      <div class="detail-card-hd">
        <div class="detail-cat">${reg.group}${reg.category?' â€º '+reg.category:''}</div>
        <div class="detail-ttl">${reg.title}</div>
      </div>
      <div class="meta-strip">
        <div class="meta-cell"><div class="meta-k">ìƒíƒœ</div><div class="meta-v">${sBadge(reg.status)}</div></div>
        <div class="meta-cell"><div class="meta-k">ë²„ì „</div><div class="meta-v" style="font-family:'DM Mono',monospace">${reg.version}</div></div>
        <div class="meta-cell"><div class="meta-k">ì‹œí–‰ì¼</div><div class="meta-v">${reg.date||'ë¯¸ì •'}</div></div>
        <div class="meta-cell"><div class="meta-k">ë‹´ë‹¹ë¶€ì„œ</div><div class="meta-v">${reg.dept||'â€”'}</div></div>
        <div class="meta-cell"><div class="meta-k">ê°œì • íšŸìˆ˜</div><div class="meta-v">${reg.history.length}íšŒ</div></div>
      </div>
      <div class="detail-body-sec">
        <div class="sec-ttl">ê·œì • ë‚´ìš©</div>
        <div class="detail-body-txt">${escHtml(reg.body)}</div>
      </div>
      <div class="detail-body-sec" style="padding-top:0">
        <div class="sec-ttl">ê°œì • ì´ë ¥</div>
        <table class="history-tbl">
          <thead><tr><th>ì‹œí–‰ì¼</th><th>ê°œì • ë‚´ìš©</th></tr></thead>
          <tbody>${[...reg.history].reverse().map((h,i)=>`
            <tr ${i===0?'class="cur-row"':''}>
              <td style="font-family:'DM Mono',monospace;font-size:12px;white-space:nowrap">${h.date||'â€”'}${i===0?' <span style="font-family:Pretendard;font-size:10px;background:var(--accent);color:#fff;padding:1px 6px;border-radius:3px;font-weight:600;margin-left:6px">í˜„í–‰</span>':''}</td>
              <td>${h.note}</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>
      <div class="detail-actions">
        ${isAdmin ? `<button class="btn-edit" onclick="openEditModal()">âœï¸ ìˆ˜ì •</button>` : ''}
        ${canDiff?`<button class="btn-diff" onclick="showDiff('${id}')">ğŸ“„ ì‹ êµ¬ëŒ€ì¡°í‘œ</button>`:''}
        ${canDiff?`<button class="btn-timeline" onclick="showArticleHistory('${id}')">ğŸ• ì¡°í•­ì—°í˜ ë³´ê¸°</button>`:''}
        ${isAdmin ? `<button class="btn-del" onclick="openDeleteModal()">ğŸ—‘ï¸ ì‚­ì œ</button>` : ''}
      </div>
    </div>`;
}

// â”€â”€ ì‹ êµ¬ëŒ€ì¡°í‘œ â”€â”€
function showDiff(id, oldVerIdx, newVerIdx) {
  const reg = regs.find(r=>r.id===id); if(!reg||reg.history.length<2) return;
  currentView='diff'; currentId=id;
  setNav(null); buildTree();

  const h = reg.history;
  // ê¸°ë³¸: ë§ˆì§€ë§‰ ì´ì „ â†’ ë§ˆì§€ë§‰
  const oi = oldVerIdx !== undefined ? oldVerIdx : h.length-2;
  const ni = newVerIdx !== undefined ? newVerIdx : h.length-1;
  const oldH = h[oi];
  const newH = h[ni];

  // ë²„ì „ ì„ íƒ ì˜µì…˜
  const verOptions = h.map((v,i)=>`<option value="${i}" ${i===oi?'selected':''}>${v.date||'ë‚ ì§œì—†ìŒ'} (${i===0?'ì œì •':'ê°œì •'})</option>`).join('');
  const verOptions2 = h.map((v,i)=>`<option value="${i}" ${i===ni?'selected':''}>${v.date||'ë‚ ì§œì—†ìŒ'} (${i===0?'ì œì •':'ê°œì •'})</option>`).join('');

  // diff ê³„ì‚°
  const diffRows = computeDiff(oldH.body||'', newH.body||'');

  document.getElementById('content').innerHTML = `
    <div class="breadcrumb">
      <span class="bc-link" onclick="showHome()">í™ˆ</span> â€º
      <span class="bc-link" onclick="currentCat=null;showCategory('${reg.group}')">${reg.group}</span> â€º
      <span class="bc-link" onclick="showDetail('${id}')">${reg.title}</span> â€º ì‹ êµ¬ëŒ€ì¡°í‘œ
    </div>
    <div class="diff-page">
      <div class="diff-header">
        <div>
          <div class="diff-title">ğŸ“„ ì‹ êµ¬ì¡°ë¬¸ ëŒ€ì¡°í‘œ</div>
          <div class="diff-subtitle">${reg.title}</div>
        </div>
      </div>
      <div class="diff-ver-selector">
        <label>í˜„í–‰(êµ¬)</label>
        <select class="diff-ver-select" id="diffOld">${verOptions}</select>
        <span class="diff-arrow">â†’</span>
        <label>ê°œì •(ì‹ )</label>
        <select class="diff-ver-select" id="diffNew">${verOptions2}</select>
        <button class="btn-diff-apply" onclick="applyDiff('${id}')">ëŒ€ì¡° ë³´ê¸°</button>
      </div>
      <div class="diff-legend">
        <span style="font-size:12px;font-weight:600;color:var(--text-2);margin-right:8px">ë²”ë¡€</span>
        <div class="legend-item"><div class="legend-box legend-del"></div><span>ì‚­ì œÂ·ë³€ê²½(êµ¬)</span></div>
        <div class="legend-item"><div class="legend-box legend-add"></div><span>ì¶”ê°€Â·ë³€ê²½(ì‹ )</span></div>
        <div class="legend-item"><div class="legend-box legend-same"></div><span>ë™ì¼</span></div>
      </div>
      <div class="diff-col-header">
        <div class="diff-col-hd old">í˜„ í–‰ (${oldH.date||'â€”'})</div>
        <div class="diff-col-hd new">ê°œ ì • (${newH.date||'â€”'})</div>
      </div>
      <div class="diff-body" id="diffBody">
        ${renderDiffRows(diffRows)}
      </div>
    </div>`;
}

function applyDiff(id) {
  const oi = parseInt(document.getElementById('diffOld').value);
  const ni = parseInt(document.getElementById('diffNew').value);
  if(oi===ni){ showToast('âš ï¸ ì„œë¡œ ë‹¤ë¥¸ ë²„ì „ì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
  showDiff(id, oi, ni);
}

// â”€â”€ DIFF ENGINE â”€â”€
// ë¬¸ë‹¨(ì¡°í•­) ë‹¨ìœ„ë¡œ LCS ê¸°ë°˜ diff
function computeDiff(oldText, newText) {
  const oldParts = splitIntoArticles(oldText);
  const newParts = splitIntoArticles(newText);
  const lcs = buildLCS(oldParts, newParts);
  const rows = [];
  let oi=0, ni=0, li=0;
  while(oi<oldParts.length||ni<newParts.length){
    if(oi<oldParts.length&&ni<newParts.length&&li<lcs.length&&oldParts[oi]===lcs[li]&&newParts[ni]===lcs[li]){
      rows.push({type:'same', old:oldParts[oi], new:newParts[ni]});
      oi++; ni++; li++;
    } else if(oi<oldParts.length&&ni<newParts.length&&!lcs.slice(li).includes(oldParts[oi])&&!lcs.slice(li).includes(newParts[ni])){
      // ê°™ì€ ì¡°í•­ì´ ìˆ˜ì •ëœ ê²½ìš°
      rows.push({type:'changed', old:oldParts[oi], new:newParts[ni]});
      oi++; ni++;
    } else if(oi<oldParts.length&&(li>=lcs.length||oldParts[oi]!==lcs[li])){
      rows.push({type:'deleted', old:oldParts[oi], new:''});
      oi++;
    } else if(ni<newParts.length){
      rows.push({type:'added', old:'', new:newParts[ni]});
      ni++;
    } else break;
  }
  return rows;
}

function splitIntoArticles(text) {
  // ì¡°í•­(ì œNì¡°)ë³„ë¡œ ë¶„ë¦¬, ì—†ìœ¼ë©´ ë¬¸ë‹¨ë³„ ë¶„ë¦¬
  const articleRegex = /(ì œ\d+ì¡°[^\n]*(?:\n(?!ì œ\d+ì¡°)[^\n]*)*)/g;
  const matches = text.match(articleRegex);
  if(matches && matches.length > 1) return matches.map(s=>s.trim()).filter(Boolean);
  return text.split(/\n\n+/).map(s=>s.trim()).filter(Boolean);
}

function buildLCS(a, b) {
  const m=a.length, n=b.length;
  const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
  for(let i=1;i<=m;i++) for(let j=1;j<=n;j++)
    dp[i][j] = a[i-1]===b[j-1] ? dp[i-1][j-1]+1 : Math.max(dp[i-1][j],dp[i][j-1]);
  const lcs=[]; let i=m,j=n;
  while(i>0&&j>0){
    if(a[i-1]===b[j-1]){lcs.unshift(a[i-1]);i--;j--;}
    else if(dp[i-1][j]>dp[i][j-1]) i--;
    else j--;
  }
  return lcs;
}

// ì¸ë¼ì¸ diff (ë‹¨ì–´ ë‹¨ìœ„)
function inlineDiff(oldStr, newStr) {
  const ow = oldStr.split(/(\s+)/);
  const nw = newStr.split(/(\s+)/);
  const lcs = buildLCS(ow, nw);
  let oldOut='', newOut='', oi=0, ni=0, li=0;
  while(oi<ow.length||ni<nw.length){
    if(oi<ow.length&&ni<nw.length&&li<lcs.length&&ow[oi]===lcs[li]&&nw[ni]===lcs[li]){
      oldOut+=escHtml(ow[oi]); newOut+=escHtml(nw[ni]); oi++; ni++; li++;
    } else if(oi<ow.length&&(li>=lcs.length||ow[oi]!==lcs[li])){
      oldOut+=`<span class="del">${escHtml(ow[oi])}</span>`; oi++;
    } else if(ni<nw.length){
      newOut+=`<span class="ins">${escHtml(nw[ni])}</span>`; ni++;
    } else break;
  }
  return {oldOut, newOut};
}

function renderDiffRows(rows) {
  return rows.map(row=>{
    if(row.type==='same'){
      return `<div class="diff-row">
        <div class="diff-cell old-side row-same">${escHtml(row.old)}</div>
        <div class="diff-cell row-same">${escHtml(row.new)}</div>
      </div>`;
    } else if(row.type==='changed'){
      const {oldOut,newOut} = inlineDiff(row.old, row.new);
      return `<div class="diff-row">
        <div class="diff-cell old-side row-del">${oldOut}</div>
        <div class="diff-cell row-add">${newOut}</div>
      </div>`;
    } else if(row.type==='deleted'){
      return `<div class="diff-row">
        <div class="diff-cell old-side row-del">${escHtml(row.old)}</div>
        <div class="diff-cell row-empty">&lt;ì‚­ì œ&gt;</div>
      </div>`;
    } else { // added
      return `<div class="diff-row">
        <div class="diff-cell old-side row-empty">&lt;ì‹ ì„¤&gt;</div>
        <div class="diff-cell row-add">${escHtml(row.new)}</div>
      </div>`;
    }
  }).join('');
}

// â”€â”€ ì¡°í•­ì—°í˜ ë³´ê¸° â”€â”€
function showArticleHistory(id, fromDate, toDate) {
  const reg = regs.find(r=>r.id===id); if(!reg||reg.history.length<2) return;
  currentView='timeline'; currentId=id;
  setNav(null); buildTree();

  const allDates = reg.history.map(h=>h.date||'').filter(Boolean).sort();
  const minDate = allDates[0]||'';
  const maxDate = allDates[allDates.length-1]||'';

  fromDate = fromDate||minDate;
  toDate   = toDate||maxDate;

  // ë‚ ì§œ ë²”ìœ„ í•„í„°
  const filtered = reg.history.filter(h=>{
    const d = h.date||'9999';
    return d>=fromDate && d<=toDate;
  });

  // ë‚ ì§œ ì„ íƒ ì˜µì…˜
  const dateOpts1 = reg.history.map((h,i)=>`<option value="${h.date||''}" ${h.date===fromDate?'selected':''}>${h.date||'ë‚ ì§œì—†ìŒ'} (${i===0?'ì œì •':'ê°œì •'})</option>`).join('');
  const dateOpts2 = reg.history.map((h,i)=>`<option value="${h.date||''}" ${h.date===toDate?'selected':''}>${h.date||'ë‚ ì§œì—†ìŒ'} (${i===0?'ì œì •':'ê°œì •'})</option>`).join('');

  // ì „ì²´ ì¡°í•­ ëª©ë¡ ìˆ˜ì§‘
  const allArticles = collectAllArticles(filtered.map(h=>h.body||''));

  // í…Œì´ë¸” í—¤ë”
  const headers = filtered.map((h,i)=>{
    const isFirst = i===0 && reg.history.indexOf(h)===0;
    const tag = isFirst?'th-tag-new':'th-tag-rev';
    const tagLabel = isFirst?'ì œì •':'ê°œì •';
    return `<th>
      ${reg.title} ${h.date||''} <span class="th-tag ${tag}">${tagLabel}</span>
    </th>`;
  }).join('');

  // ê° ì¡°í•­ë³„ í–‰
  const rows = allArticles.map((artKey, rowIdx)=>{
    const cells = filtered.map((h, colIdx)=>{
      const body = h.body||'';
      const arts = splitIntoArticles(body);
      // ì¡°í•­ ë²ˆí˜¸ë¡œ ë§¤ì¹­
      const match = arts.find(a=>extractArticleKey(a)===artKey);

      // ì´ì „ ë²„ì „ê³¼ ë¹„êµí•´ì„œ ë³€ê²½ì—¬ë¶€ íŒë‹¨
      let tdClass = '';
      if(!match){
        tdClass = 'td-empty';
      } else if(colIdx===0){
        tdClass = '';
      } else {
        const prevH = filtered[colIdx-1];
        const prevArts = splitIntoArticles(prevH.body||'');
        const prevMatch = prevArts.find(a=>extractArticleKey(a)===artKey);
        if(!prevMatch) tdClass='td-added';
        else if(prevMatch!==match) tdClass='td-changed';
      }

      if(tdClass==='td-empty'){
        return `<td class="td-empty">â€”</td>`;
      }
      const lines = match.split('\n');
      const titleLine = lines[0];
      const rest = lines.slice(1).join('\n');
      return `<td class="${tdClass}"><span class="tl-art-title">${escHtml(titleLine)}</span>${escHtml(rest)}</td>`;
    }).join('');

    return `<tr>
      <td class="row-label">ì œ${rowIdx+1}ì¡°</td>
      ${cells}
    </tr>`;
  }).join('');

  document.getElementById('content').innerHTML = `
    <div class="breadcrumb">
      <span class="bc-link" onclick="showHome()">í™ˆ</span> â€º
      <span class="bc-link" onclick="currentCat=null;showCategory('${reg.group}')">${reg.group}</span> â€º
      <span class="bc-link" onclick="showDetail('${id}')">${reg.title}</span> â€º ì¡°í•­ì—°í˜
    </div>
    <div class="timeline-page">
      <div class="timeline-top">
        <div class="timeline-top-title">ğŸ• ì¡°í•­ì—°í˜ ë³´ê¸°</div>
        <div class="timeline-top-sub">${reg.title} â€” ë²„ì „ë³„ ì¡°í•­ ë³€ê²½ ì´ë ¥</div>
      </div>
      <div class="timeline-controls">
        <label>ì—°í˜</label>
        <select class="tl-date-select" id="tlFrom">${dateOpts1}</select>
        <span style="color:var(--text-3)">~</span>
        <select class="tl-date-select" id="tlTo">${dateOpts2}</select>
        <button class="btn-tl-apply" onclick="applyTimeline('${id}')">ë³´ê¸°</button>
        <span style="font-size:11px;color:var(--text-3);margin-left:8px">
          ğŸŸ¡ ë³€ê²½ëœ ì¡°í•­&nbsp;&nbsp;ğŸŸ¢ ì‹ ì„¤ ì¡°í•­&nbsp;&nbsp;â€” í•´ë‹¹ì—†ìŒ
        </span>
      </div>
      <div class="timeline-scroll-wrap">
        <table class="timeline-table">
          <thead>
            <tr>
              <th style="position:sticky;left:0;z-index:20;background:#dce4f0;width:80px;min-width:80px;">ì¡°í•­</th>
              ${headers}
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;
}

function applyTimeline(id) {
  const from = document.getElementById('tlFrom').value;
  const to   = document.getElementById('tlTo').value;
  showArticleHistory(id, from, to);
}

function collectAllArticles(bodies) {
  const keys = [];
  const seen = new Set();
  bodies.forEach(body=>{
    const arts = splitIntoArticles(body);
    arts.forEach(a=>{
      const k = extractArticleKey(a);
      if(k && !seen.has(k)){ keys.push(k); seen.add(k); }
    });
  });
  return keys;
}

function extractArticleKey(articleText) {
  // "ì œ1ì¡°", "ì œ1ì¡°(ëª©ì )" ë“±ì—ì„œ ì¡° ë²ˆí˜¸ ì¶”ì¶œ
  const m = articleText.match(/^ì œ(\d+)ì¡°/);
  if(m) return `ì œ${m[1]}ì¡°`;
  // ì¡° ì—†ìœ¼ë©´ ì²« ì¤„ ìì²´ë¥¼ í‚¤ë¡œ
  return articleText.split('\n')[0].trim().slice(0,20);
}
function doSearch() {
  const q=document.getElementById('hsInput').value.trim();
  const type=document.getElementById('hsType').value;
  if(!q) return;
  const results=regs.filter(r=>type==='title'?r.title.includes(q):(r.body||'').includes(q));
  currentView='list'; currentGroup=null; currentCat=null;
  setNav('nav-law'); buildTree();
  document.getElementById('content').innerHTML = `
    <div class="view-hd"><div class="view-ttl">ğŸ” ê²€ìƒ‰ ê²°ê³¼</div></div>
    <p class="srch-result-lbl">"<strong>${q}</strong>" â€” ${results.length}ê±´</p>
    ${results.length===0?'<div class="reg-table"><div class="empty-tbl">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>':
    `<div class="reg-table"><table>
      <thead><tr><th style="width:38%">ê·œì •ëª…</th><th>ë¶„ë¥˜</th><th>ìƒíƒœ</th><th>ì‹œí–‰ì¼</th><th>ê´€ë¦¬ë¶€ì„œ</th></tr></thead>
      <tbody>${results.map(r=>`<tr onclick="showDetail('${r.id}')">
        <td class="td-ttl">${r.title}</td>
        <td style="font-size:12px;color:var(--text-3)">${r.group}</td>
        <td>${sBadge(r.status)}</td>
        <td style="font-size:12px;color:var(--text-3)">${r.date||'â€”'}</td>
        <td style="font-size:12px;color:var(--text-3)">${r.dept||'â€”'}</td>
      </tr>`).join('')}</tbody>
    </table></div>`}`;
}

function onSbSearch() {
  const q=document.getElementById('sbSearch').value.trim();
  if(!q){ showHome(); return; }
  const results=regs.filter(r=>r.title.includes(q));
  currentView='list'; currentGroup=null; currentCat=null; buildTree();
  document.getElementById('content').innerHTML = `
    <div class="view-hd"><div class="view-ttl">ğŸ” "${q}"</div></div>
    <p class="srch-result-lbl">${results.length}ê±´</p>
    ${results.length===0?'<div class="reg-table"><div class="empty-tbl">ê²°ê³¼ ì—†ìŒ</div></div>':
    `<div class="reg-table"><table>
      <thead><tr><th style="width:40%">ê·œì •ëª…</th><th>ë¶„ë¥˜</th><th>ìƒíƒœ</th><th>ê´€ë¦¬ë¶€ì„œ</th></tr></thead>
      <tbody>${results.map(r=>`<tr onclick="showDetail('${r.id}')">
        <td class="td-ttl">${r.title}</td>
        <td style="font-size:12px;color:var(--text-3)">${r.group}</td>
        <td>${sBadge(r.status)}</td>
        <td style="font-size:12px;color:var(--text-3)">${r.dept||'â€”'}</td>
      </tr>`).join('')}</tbody>
    </table></div>`}`;
}

// â”€â”€ MODALS â”€â”€
function openCreateModal() {
  if(!isAdmin){ showToast('âš ï¸ ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'); openLoginModal(); return; }
  editMode=false;
  document.getElementById('modalTitle').textContent='ìƒˆ ê·œì • ë“±ë¡';
  clearForm();
  document.getElementById('fVersion').value='v1.0';
  document.getElementById('fDate').value=new Date().toISOString().split('T')[0];
  if(currentGroup) document.getElementById('fGroup').value=currentGroup;
  document.getElementById('fRevRow').style.display='none';
  openModal('formModal');
}

function openEditModal() {
  if(!isAdmin){ showToast('âš ï¸ ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'); openLoginModal(); return; }
  const reg=regs.find(r=>r.id===currentId); if(!reg) return;
  editMode=true;
  document.getElementById('modalTitle').textContent='ê·œì • ìˆ˜ì •';
  document.getElementById('fTitle').value=reg.title;
  document.getElementById('fGroup').value=reg.group;
  document.getElementById('fCategory').value=reg.category||'';
  document.getElementById('fStatus').value=reg.status;
  document.getElementById('fVersion').value=reg.version;
  document.getElementById('fDate').value=reg.date||'';
  document.getElementById('fDept').value=reg.dept||'';
  document.getElementById('fBody').value=reg.body;
  document.getElementById('fRevNote').value='';
  document.getElementById('fRevRow').style.display='block';
  openModal('formModal');
}

async function saveReg() {
  const title=document.getElementById('fTitle').value.trim();
  const group=document.getElementById('fGroup').value;
  const cat=document.getElementById('fCategory').value.trim();
  const status=document.getElementById('fStatus').value;
  const version=document.getElementById('fVersion').value.trim();
  const date=document.getElementById('fDate').value;
  const dept=document.getElementById('fDept').value.trim();
  const body=document.getElementById('fBody').value.trim();
  const revNote=document.getElementById('fRevNote').value.trim();
  if(!title||!group||!version||!body){ showToast('âš ï¸ í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if(!editMode){
    const nr={id:'r'+Date.now(),title,group,category:cat,status,version,date,dept,body,
      history:[{version,date:date||new Date().toISOString().split('T')[0],note:'ìµœì´ˆ ì œì •',body}]};
    regs.unshift(nr); currentId=nr.id;
    showToast('âœ… ê·œì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
  } else {
    const reg=regs.find(r=>r.id===currentId);
    const changed=reg.version!==version||reg.body!==body;
    Object.assign(reg,{title,group,category:cat,status,version,date,dept,body});
    if(changed) reg.history.push({version,date:new Date().toISOString().split('T')[0],note:revNote||'ë‚´ìš© ìˆ˜ì •',body});
    showToast('âœ… ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
  }
  Storage.save(regs);
  await Storage.upsert(regs.find(r=>r.id===currentId));
  closeModal('formModal'); buildTree(); showDetail(currentId);
}

function openDeleteModal() {
  if(!isAdmin){ showToast('âš ï¸ ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'); openLoginModal(); return; }
  const reg=regs.find(r=>r.id===currentId); if(!reg) return;
  deleteTargetId=currentId;
  document.getElementById('deleteTargetName').textContent=reg.title;
  openModal('deleteModal');
}
async function confirmDelete() {
  await Storage.remove(deleteTargetId);
  regs=regs.filter(r=>r.id!==deleteTargetId);
  Storage.save(regs); closeModal('deleteModal');
  currentId=null; showToast('ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'); buildTree(); showHome();
}
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function clearForm(){
  ['fTitle','fGroup','fCategory','fStatus','fVersion','fDate','fDept','fBody','fRevNote'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value=el.tagName==='SELECT'?el.options[0].value:'';
  });
}
document.querySelectorAll('.modal-backdrop').forEach(el=>{
  el.addEventListener('click',e=>{ if(e.target===el) el.classList.remove('open'); });
});

// â”€â”€ UTILS â”€â”€
function sBadge(s){
  const m={active:['ì‹œí–‰ì¤‘','sbadge-active'],draft:['ì´ˆì•ˆ','sbadge-draft'],obsolete:['íê¸°','sbadge-obsolete']};
  const [l,c]=m[s]||['â€”',''];
  return `<span class="sbadge ${c}">${l}</span>`;
}
function escHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
let toastTimer;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),2800);
}

initData();
</script>
</body>
</html>
